#!/usr/bin/env bash

set -euo pipefail
shopt -s extglob

readonly TMPDIR="/tmp/dotfiles_installer"
readonly CONFIG_FILE="${TMPDIR}/install_config.env"
declare -A SELECTIONS

init_tmpdir() {
    mkdir -p "$TMPDIR"
}

ask_yes_no() {
    local prompt="$1"
    local response
    while true; do
        printf "%s [y/n]: " "$prompt"
        read -r response
        case "$response" in
            [Yy]*) return 0 ;;
            [Nn]*) return 1 ;;
        esac
    done
}

# WIP
multiple_choice() {
  local prompt="$1"
  local response
  while true; do
    printf "%s [0-9]: " "$prompt"
    read -r response
  done
}

collect_top_level_choices() {
    if ask_yes_no "Install Neovim?"; then
        SELECTIONS["nvim"]=1
    fi
    if ask_yes_no "Include Media Tools?"; then
        SELECTIONS["media"]=1
    fi
    if ask_yes_no "Include Networking Tools?"; then
        SELECTIONS["net"]=1
    fi
}

collect_sub_choices() {
    if [[ ${SELECTIONS[nvim]+x} ]]; then
        ask_yes_no " - Configure Neovim?" && SELECTIONS["conf_nvim"]=1
        ask_yes_no " - Install build-essential?" && SELECTIONS["dev_build-essential"]=1
    fi
    if [[ ${SELECTIONS[media]+x} ]]; then
        ask_yes_no " - Install VLC?" && SELECTIONS["media_vlc"]=1
        ask_yes_no " - Install GIMP?" && SELECTIONS["media_gimp"]=1
        ask_yes_no " - Install Audacity?" && SELECTIONS["media_audacity"]=1
    fi
    if [[ ${SELECTIONS[net]+x} ]]; then
        ask_yes_no " - Install Curl?" && SELECTIONS["net_curl"]=1
        ask_yes_no " - Install Wget?" && SELECTIONS["net_wget"]=1
        ask_yes_no " - Install Nmap?" && SELECTIONS["net_nmap"]=1
    fi
}

write_config() {
    : > "$CONFIG_FILE"
    {
        printf "#!/usr/bin/env bash\n\n"
        printf "DEV_TOOLS=("
        [[ ${SELECTIONS[dev_git]+x} ]] && printf "'nvim' "
        [[ ${SELECTIONS[dev_vim]+x} ]] && printf "'vim' "
        [[ ${SELECTIONS[dev_build-essential]+x} ]] && printf "'build-essential' "
        printf ")\n"

        printf "MEDIA_TOOLS=("
        [[ ${SELECTIONS[media_vlc]+x} ]] && printf "'vlc' "
        [[ ${SELECTIONS[media_gimp]+x} ]] && printf "'gimp' "
        [[ ${SELECTIONS[media_audacity]+x} ]] && printf "'audacity' "
        printf ")\n"

        printf "NET_UTILS=("
        [[ ${SELECTIONS[net_curl]+x} ]] && printf "'curl' "
        [[ ${SELECTIONS[net_wget]+x} ]] && printf "'wget' "
        [[ ${SELECTIONS[net_nmap]+x} ]] && printf "'nmap' "
        printf ")\n"
    } > "$CONFIG_FILE"

    chmod +x "$CONFIG_FILE"
}

call_install_scripts() {
    [[ -f ./install_dev.sh ]] && ./install_dev.sh "$CONFIG_FILE"
    [[ -f ./install_media.sh ]] && ./install_media.sh "$CONFIG_FILE"
    [[ -f ./install_net.sh ]] && ./install_net.sh "$CONFIG_FILE"
}

#
# main() {
#     init_tmpdir
#     collect_top_level_choices
#     collect_sub_choices
#     write_config
#     call_install_scripts
# }
#
# main "$@"
#
